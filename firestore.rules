rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       FUNÇÕES AUXILIARES
    ========================= */

    function isAuthenticated() {
      return request.auth != null;
    }

    function isCampaignOwner(campaignId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/campaigns/$(campaignId))
             .data.ownerId == request.auth.uid;
    }

    function isCharacterOwner(campaignId, characterId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/campaigns/$(campaignId)/characters/$(characterId))
             .data.playerId == request.auth.uid;
    }

    function characterStatus(campaignId, characterId) {
      return get(/databases/$(database)/documents/campaigns/$(campaignId)/characters/$(characterId))
             .data.status;
    }

    /* =========================
       CAMPAIGNS
    ========================= */

    match /campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isCampaignOwner(campaignId);

      /* =========================
         CHARACTERS
      ========================= */

      match /characters/{characterId} {

        allow read: if isAuthenticated();

        // Criação do personagem (sempre começa como draft)
        allow create: if isAuthenticated()
          && request.resource.data.playerId == request.auth.uid
          && request.resource.data.status == "draft";

        // Atualização controlada
        allow update: if isCharacterOwner(campaignId, characterId)
          && (
            // Pode editar livremente enquanto for draft
            characterStatus(campaignId, characterId) == "draft"

            ||

            // Se estiver ativo, só campos não críticos
            (
              characterStatus(campaignId, characterId) == "active"
              && !("status" in request.resource.data)
            )
          );

        allow delete: if isCampaignOwner(campaignId);

        /* =========================
           SUBDOCUMENTOS DO PERSONAGEM
        ========================= */

        match /{subdoc} {
          allow read: if isAuthenticated();

          // Escrita só pelo dono do personagem
          allow write: if isCharacterOwner(campaignId, characterId)
            && (
              // Tudo liberado enquanto draft
              characterStatus(campaignId, characterId) == "draft"

              ||

              // Após ativo, restringe documentos críticos
              (
                characterStatus(campaignId, characterId) == "active"
                && subdoc in [
                  "inventory",
                  "reputation",
                  "progression",
                  "gameplay"
                ]
              )
            );
        }
      }

      /* =========================
         SESSIONS (NARRATIVA)
      ========================= */

      match /sessions/{sessionId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && request.resource.data.characterId is string;

        // Sessões nunca são editadas ou apagadas
        allow update, delete: if false;
      }
    }
  }
}
